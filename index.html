<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">

    <style>

      body {
        font: 12px sans-serif;
      }

      path {
        stroke-width:0.5px;
        stroke: #FFF;
        cursor: pointer;
      }

      /*needed for positioning d3 tooltip with JS */
      div.tooltip {  
        position: absolute;     
        width: 90px;  
        height: inherit;          
        padding: 5px;       
        background: rgba(0,0,0,0.6);
        border-radius: 3px;     
        pointer-events: none;
        font-size: 12px;
        color: #fff;    
        box-shadow: 3px 3px 3px #d3d3d3;
        font-family: 'Source Sans Pro', sans-serif;
      }

    </style>

  </head>

  <body>

      <div id="wrapper"></div>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.1.1/chroma.min.js"></script>


    <script>

    var width = 1000,
        height = 700;

    // create map container and add to 
    var div = d3.select('#wrapper')
      .append("div")  
      .attr("class", "tooltip")        
      .style("opacity", 0);

    //Map projection
    var projection = d3.geo.mercator()
        .scale(300)
        .center([-135.77330276459485,75.44927205499978]) //projection center
        .translate([width/10,height/10]) //translate to center the map in view

    //Generate paths based on projection
    var path = d3.geo.path()
        .projection(projection);

    //Create an SVG and append to wrapper
    var svg = d3.select("#wrapper")
        .append("svg")
        .attr("width", width)
        .attr("height", height)

    //Group for the map features
    var features = svg.append("g")
        .attr("class","features")

    //Create zoom/pan listener
    //Change [1,Infinity] to adjust the min/max zoom scale
    var zoom = d3.behavior.zoom()
        .scaleExtent([1, Infinity])
        .on("zoom",zoomed);

    svg.call(zoom);

    //use queue library to load data togetger so it can be combined
    queue()
      .defer(d3.json, "newcensus3.geojson")
      .defer(d3.json, "data.json")
      .await(ready);

    function ready(error, geo, data) {
      if (error) throw error;

      var geo2 = geo.features;

      // loop through the geojson, 
      geo2.forEach(function(mapdata){
        var result = data.filter(function(responses) {
            // find matches between the two IDs and save to result. Use parseInt to ensure integers
            return parseInt(responses.id) === parseInt(mapdata.properties.CENSUSID);
        });
        // if the ID is in both files, participants becomes the value from the other file
        if (result[0]!== undefined){
          mapdata.participants = result[0].value;
        }
        // otherwise set the value to zero
        else {
          mapdata.participants = 0;
        }
      });

      var dataArray = [];
      for (var d = 0; d < geo2.length; d++) {
        dataArray.push(parseFloat(geo2[d].participants))
      }

      // set the max and min and the color range
      var minVal = d3.min(dataArray)
      var maxVal = d3.max(dataArray)

      // option 1 for colors
      // var color = d3.scale.linear()
      //      .domain([1, 3, 10, 20, 30, 60, 90])
      //      .range(["#deebf7", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#08519c", "#08306b"])

      // option 2 for colors
      var domainpicker = chroma.limits(dataArray, 'k', 6);
      var color = chroma.scale(["#e4eff8", "#08306b"])
          .domain(domainpicker);

      //Create a path for each map feature in the data
      features.selectAll("path")
        .data(geo2)
        .enter()
        .append("path")
        .attr("d",path)
        // use the color range for the fill
        .style("fill", function(d) {
          return color(d.participants); 
        })
        .on("mouseover",tooltip)
        .on("mouseout",tooltipout);
    }

    // onclick/mousein/mouseout events with acess to d
    function tooltip(d,i) {
      div.transition()   
      .duration(200)    
      .style("opacity", 1);   
      div.html("<strong>"+d.properties.censusinfo_GeographicName + "</strong><br>Participants: " + d.participants + "<br> Population: " + d.properties.population) 
         .style("left", (d3.event.pageX) + "px")    
         .style("top", (d3.event.pageY) + "px");  
    }

    function tooltipout(d,i) {
      div.transition()    
          .duration(500)    
          .style("opacity", 0); 
    }

    //Update map on zoom/pan
    function zoomed() {
      features.attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")")
          .selectAll("path").style("stroke-width", 0.5 / zoom.scale() + "px" );
    }

    </script>
    </body>